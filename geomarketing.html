<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartesia Maps - Geomarketing</title>
    
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* Estilos específicos para a página de geomarketing */
        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #f4f4f4;
        }
        body {
            display: flex;
        }
        main.geomarketing-main {
            height: 100%;
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            margin-top: 0;
            padding: 0;
        }
        #map { height: 100%; width: 100%; cursor: default; z-index: 1; }
        .legend { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; line-height: 18px; color: #555; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        .toolbar-btn { display: flex; align-items: center; padding: 8px 12px; border-radius: 6px; background-color: white; border: 1px solid #d1d5db; color: #374151; font-weight: 500; transition: all 0.2s; }
        .toolbar-btn:hover:not(:disabled) { background-color: #f9fafb; border-color: #6b7280; }
        .toolbar-btn.active { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
        .toolbar-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .toolbar-btn svg { margin-right: 8px; }
        .accordion-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-header .arrow { transition: transform 0.3s ease-out; }
        .accordion-item.open .accordion-content { max-height: 500px; }
        .accordion-item.open .arrow { transform: rotate(180deg); }
        .loader { display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(0,0,0,.1); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; margin-left: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .layer-manager-item { display: flex; align-items: center; justify-content: space-between; padding: 4px; border-radius: 4px; }
        .layer-manager-item:hover { background-color: #f9fafb; }
        .layer-manager-item .actions button { background: none; border: none; cursor: pointer; color: #9ca3af; padding: 2px; }
        .layer-manager-item .actions button:hover { color: #374151; }
        #basemap-container { z-index: 999; }
        #basemap-container:hover .basemap-options { display: flex; }
        .basemap-options { display: none; }
    </style>
</head>
<body>
    <button id="sidebarToggle" class="hamburger-btn">
        <i class="fas fa-bars"></i>
    </button>

    <nav id="sidebar">
        <ul>
            <li><a href="index.html">Página Inicial</a></li>
            <li><a href="index.html#about">Sobre Nós</a></li>
            <li><a href="index.html#team">Equipe</a></li>
            <li><a href="index.html#portfolio">Portfólio</a></li>
            <li><a href="geomarketing.html" class="active-link">Geomarketing</a></li>
        </ul>
    </nav>

    <main class="geomarketing-main">
        <div class="flex flex-col h-screen w-full">
            <div class="bg-white shadow-sm p-2 z-20">
                 <div class="container mx-auto flex items-center space-x-2 overflow-x-auto">
                     <button id="tool-point" class="toolbar-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>Ponto</button>
                     <button id="tool-polygon" class="toolbar-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7.252 1.46a.5.5 0 0 1 .496 0l6.5 3.572a.5.5 0 0 1 0 .896l-6.5 3.572a.5.5 0 0 1-.496 0L.752 6.824a.5.5 0 0 1 0-.896l6.5-3.572zM.002 6.084a.5.5 0 0 1 .496 0l6.5 3.572a.5.5 0 0 1 0 .896l-6.5 3.572a.5.5 0 0 1-.496 0L.002 11.18a.5.5 0 0 1 0-.896l6.5-3.572L.002 7.084a.5.5 0 0 1 0-.896z"/></svg>Desenho</button>
                     <button id="tool-isochrone" class="toolbar-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16a.5.5 0 0 0 .5-.5V1a.5.5 0 0 0-1 0v14.5A.5.5 0 0 0 8 16zM8 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 4zM4.5 8a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 0-1h-7a.5.5 0 0 0-.5.5z"/></svg>Deslocamento</button>
                     <button id="tool-ruler" class="toolbar-btn"><svg xmlns="http://www.w.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M.5 9.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5zM.5 6.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5zM15.5 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V4h-1a.5.5 0 0 1 0-1h1.5zM12.5 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V4h-1a.5.5 0 0 1 0-1h1.5zM9.5 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V4h-1a.5.5 0 0 1 0-1h1.5zM6.5 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V4H5a.5.5 0 0 1 0-1h1.5z"/></svg>Régua</button>
                     <button id="tool-export" class="toolbar-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>Exportar</button>
                 </div>
            </div>
    
            <div class="flex-1 flex overflow-hidden relative">
                <aside id="layers-panel" class="w-full md:w-1/3 lg:w-1/4 xl:w-1/5 bg-white p-6 overflow-y-auto shadow-lg z-10">
                    <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Análises e Camadas</h2>
                    <div id="accordion-container" class="space-y-1"></div>
                </aside>
    
                <div class="flex-1 bg-gray-200 relative">
                    <div id="map"></div>
                    <div id="basemap-container" class="absolute bottom-4 right-4 bg-white rounded-md shadow-lg z-[999]">
                        <div id="basemap-active" class="p-2 cursor-pointer flex items-center"></div>
                        <div class="basemap-options absolute bottom-full mb-2 right-0 bg-white rounded-md shadow-lg p-2 flex-col space-y-2"></div>
                    </div>
                </div>
            </div>
            
            <div id="isochrone-modal" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-2xl z-[1001] w-96">
                </div>
            <div id="point-style-modal" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-2xl z-[1001] w-80">
                </div>
        </div>
    </main>
    
    <script>
        // Menu hambúrguer
        document.addEventListener('DOMContentLoaded', function() {
            const sidebar = document.getElementById('sidebar');
            const sidebarToggle = document.getElementById('sidebarToggle');
            sidebarToggle.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });
        });

        // ===================================================================
        // AQUI COMEÇA O CÓDIGO DA FERRAMENTA DE GEOMARKETING
        // ===================================================================
        
        const map = L.map('map', { drawControl: false }).setView([-21.755, -41.31], 14);
        
        const baseLayers = {
            'Claro': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB' }),
            'Escuro': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB' }),
            'Satélite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' }),
            'Ruas': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' })
        };
        let currentBaseLayerName = 'Claro';
        baseLayers[currentBaseLayerName].addTo(map);

        const drawnItems = new L.FeatureGroup().addTo(map);
        let activeTool = null;
        const activeLayers = {};
        let drawnLayerCounter = 0;
        
        // Dados para os menus
        const accordionData=[{id:"accordion-drawn",title:"Minhas Camadas",content:[{type:"placeholder",text:"Use as ferramentas para criar camadas."}]},{id:"accordion-ibge",title:"Análise Sociodemográfica (IBGE)",content:[{type:"radio",name:"choropleth",value:"population",label:"População Residente"},{type:"radio",name:"choropleth",value:"income",label:"Renda Média Domiciliar"}]},{id:"accordion-rfb",title:"Dados da Receita Federal (CNAE)",content:[{type:"checkbox",id:"rfb_supermercados",label:"Supermercados"},{type:"checkbox",id:"rfb_farmacias",label:"Farmácias"},{type:"checkbox",id:"rfb_restaurantes",label:"Restaurantes"}]}];
        const accordionContainer=document.getElementById("accordion-container");
        accordionData.forEach((e,t)=>{const o=document.createElement("div");o.id=e.id,o.className="accordion-item border-b border-gray-200",o.innerHTML=`<div class="accordion-header"><h3 class="font-semibold text-gray-600">${e.title}</h3><svg class="arrow w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div><div class="accordion-content"><div class="p-2 space-y-2">${e.content.map(l=>{const a=l.id||l.value,s=`<span class="text-gray-700">${l.label}</span><div id="loader_${a}" class="loader hidden"></div>`;return"placeholder"===l.type?`<p id="drawn-layers-placeholder" class="text-xs text-gray-500 p-2">${l.text}</p><div id="drawn-layers-list"></div>`:"radio"===l.type?`<label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="${l.name}" value="${l.value}" class="form-radio text-blue-600 choropleth-radio"> ${s}</label>`:"checkbox"===l.type?`<label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="${l.id}" class="form-checkbox text-teal-500 rounded layer-checkbox"> ${s}</label>`:""}).join("")}</div></div>`,accordionContainer.appendChild(o)});
        document.querySelectorAll(".accordion-header").forEach(e=>{e.addEventListener("click",()=>{e.parentElement.classList.toggle("open")})});

        // Lógica de Deslocamento/Isócronas
        const apiKey='eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImNkODI1ZGVhMDcxZjRhYTI5YTc1ZmViMzA0MTYwOGYyIiwiaCI6Im11cm11cjY0In0=';
        // ... (código completo para o modal e a função de isócrona deve ser inserido aqui) ...
        
        // Demais funções da ferramenta de geomarketing...
        // ... (código para toggleLoader, fetchIBGEData, parseCSV, updateChoropleth, etc.) ...
        // ... (código para as ferramentas de desenho, addLayerToManager com todas as opções, etc.) ...
        
        // Seletor de Mapa Base Otimizado
        const basemapContainer = document.getElementById('basemap-container');
        const activeBasemapDiv = document.getElementById('basemap-active');
        const basemapOptionsDiv = basemapContainer.querySelector('.basemap-options');
        const basemapThumbnails = {
            'Claro': 'https://carto.com/help/images/building-maps/basemaps/positron.png',
            'Escuro': 'https://carto.com/help/images/building-maps/basemaps/dark-matter.png',
            'Satélite': 'https://www.esri.com/arcgis-blog/wp-content/uploads/2021/11/world-imagery-wayback-2021-1024x725.png',
            'Ruas': 'https://www.openstreetmap.org/assets/about/osm-a74d20035a57662eaa360a09971914c45388d75723947497f58b0292b0365a7e.png'
        };

        function updateActiveBasemapDisplay() {
            activeBasemapDiv.innerHTML = `<img src="${basemapThumbnails[currentBaseLayerName]}" alt="${currentBaseLayerName}" class="w-16 h-12 object-cover rounded-sm"><span class="text-sm font-medium ml-2">${currentBaseLayerName}</span>`;
        }

        function createBasemapSwitcher() {
            Object.keys(baseLayers).forEach(name => {
                const button = document.createElement('button');
                button.className = 'p-1 rounded-md border-2 border-transparent hover:border-blue-500 transition-all group w-full';
                button.innerHTML = `<img src="${basemapThumbnails[name]}" alt="${name}" class="w-16 h-12 object-cover rounded-sm mx-auto"><span class="text-xs block text-center">${name}</span>`;
                button.addEventListener('click', () => {
                    if (currentBaseLayerName !== name) {
                        map.removeLayer(baseLayers[currentBaseLayerName]);
                        currentBaseLayerName = name;
                        baseLayers[currentBaseLayerName].addTo(map);
                        baseLayers[currentBaseLayerName].bringToBack();
                        updateActiveBasemapDisplay();
                    }
                });
                basemapOptionsDiv.appendChild(button);
            });
            updateActiveBasemapDisplay();
        }
        
        createBasemapSwitcher();
    </script>
</body>
</html>
