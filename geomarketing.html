<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cartesia Maps - Plataforma de Geomarketing</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://npmcdn.com/leaflet-geometryutil"></script>

    <style>
        #map { height: 100%; width: 100%; cursor: default; }
        .legend { padding: 6px 8px; font: 14px/16px Arial, Helvetica, sans-serif; background: rgba(255,255,255,0.8); box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; line-height: 18px; color: #555; }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; }
        .toolbar-btn { display: flex; align-items: center; padding: 8px 12px; border-radius: 6px; background-color: white; border: 1px solid #d1d5db; color: #374151; font-weight: 500; transition: all 0.2s; }
        .toolbar-btn:hover:not(:disabled) { background-color: #f9fafb; border-color: #6b7280; }
        .toolbar-btn.active { background-color: #eff6ff; border-color: #3b82f6; color: #1d4ed8; }
        .toolbar-btn:disabled { opacity: 0.7; cursor: not-allowed; }
        .toolbar-btn svg { margin-right: 8px; }
        .accordion-header { cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out; }
        .accordion-header .arrow { transition: transform 0.3s ease-out; }
        .accordion-item.open .accordion-content { max-height: 500px; }
        .accordion-item.open .arrow { transform: rotate(180deg); }
        .loader { display: inline-block; width: 1rem; height: 1rem; border: 2px solid rgba(0,0,0,.1); border-radius: 50%; border-top-color: #3b82f6; animation: spin 1s ease-in-out infinite; margin-left: 8px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #info-panel { transition: transform 0.3s ease-in-out; transform: translateX(-100%); }
        #info-panel.open { transform: translateX(0); }
        .layer-manager-item { display: flex; align-items: center; justify-content: space-between; padding: 4px; border-radius: 4px; }
        .layer-manager-item:hover { background-color: #f9fafb; }
        .layer-manager-item .actions button { background: none; border: none; cursor: pointer; color: #9ca3af; padding: 2px; }
        .layer-manager-item .actions button:hover { color: #374151; }
        .layer-name-input { border: 1px solid #3b82f6; border-radius: 4px; padding: 2px 4px; font-size: 0.875rem; width: 100%; }
    </style>
</head>
<body class="bg-gray-100 font-sans">

    <div class="flex flex-col h-screen">
        <header class="bg-white shadow-md z-30">
            <div class="container mx-auto px-6 py-4"><h1 class="text-2xl font-bold text-gray-800"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" /></svg>Cartesia Maps</h1></div>
        </header>

        <div class="bg-white shadow-sm p-2 z-20">
             <div class="container mx-auto flex items-center space-x-2">
                 <button id="tool-point" class="toolbar-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/></svg>Ponto</button>
                 <button id="tool-polygon" class="toolbar-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M7.252 1.46a.5.5 0 0 1 .496 0l6.5 3.572a.5.5 0 0 1 0 .896l-6.5 3.572a.5.5 0 0 1-.496 0L.752 6.824a.5.5 0 0 1 0-.896l6.5-3.572zM.002 6.084a.5.5 0 0 1 .496 0l6.5 3.572a.5.5 0 0 1 0 .896l-6.5 3.572a.5.5 0 0 1-.496 0L.002 11.18a.5.5 0 0 1 0-.896l6.5-3.572L.002 7.084a.5.5 0 0 1 0-.896z"/></svg>Desenho Livre</button>
                 <button id="tool-isochrone" class="toolbar-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16a.5.5 0 0 0 .5-.5V1a.5.5 0 0 0-1 0v14.5A.5.5 0 0 0 8 16zM8 4a.5.5 0 0 1 .5.5v7a.5.5 0 0 1-1 0v-7A.5.5 0 0 1 8 4zM4.5 8a.5.5 0 0 0 .5.5h7a.5.5 0 0 0 0-1h-7a.5.5 0 0 0-.5.5z"/></svg>Deslocamento</button>
                 <button id="tool-ruler" class="toolbar-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M.5 9.5a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5zM.5 6.5a.5.5 0 0 1 .5-.5h2a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5zm0-3a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H1a.5.5 0 0 1-.5-.5zM15.5 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V4h-1a.5.5 0 0 1 0-1h1.5zM12.5 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V4h-1a.5.5 0 0 1 0-1h1.5zM9.5 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V4h-1a.5.5 0 0 1 0-1h1.5zM6.5 3a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-1 0V4H5a.5.5 0 0 1 0-1h1.5z"/></svg>Régua</button>
                 <button id="tool-export" class="toolbar-btn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/><path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/></svg>Exportar Mapa</button>
             </div>
        </div>

        <div class="flex-1 flex overflow-hidden relative">
            <aside id="layers-panel" class="w-full md:w-1/3 lg:w-1/4 xl:w-1/5 bg-white p-6 overflow-y-auto shadow-lg z-10">
                <h2 class="text-lg font-semibold text-gray-700 mb-4 border-b pb-2">Análises e Camadas</h2>
                <div id="accordion-container" class="space-y-1">
                    </div>
            </aside>

            <aside id="info-panel" class="absolute top-0 left-0 h-full w-full md:w-1/3 lg:w-1/4 xl:w-1/5 bg-white p-6 overflow-y-auto shadow-lg z-20 border-l-2 border-blue-500">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-semibold text-gray-800">Detalhes do Setor</h2>
                    <button id="close-info-panel" class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
                </div>
                <div id="info-content" class="space-y-4">
                    <p class="text-gray-500">Clique em um setor no mapa para ver os detalhes.</p>
                </div>
            </aside>

            <main class="flex-1 bg-gray-200 relative">
                <div id="map"></div>
                
                <div id="basemap-switcher" class="absolute bottom-4 right-4 bg-white rounded-md shadow-lg z-[1000] p-2 flex flex-col space-y-2">
                    </div>

                <div id="isochrone-modal" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-2xl z-[1001] w-96">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Calcular Área de Deslocamento</h3>
                        <button id="close-isochrone-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Cálculo</label>
                            <div class="flex space-x-2" id="isochrone-calc-type">
                                <button data-type="isochrone" class="flex-1 p-2 rounded-md border bg-blue-100 border-blue-500 text-blue-700">Isócrona (Tempo Real)</button>
                                <button data-type="radius" class="flex-1 p-2 rounded-md border">Raio (Distância Simples)</button>
                            </div>
                        </div>
                        <div id="isochrone-options">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Modo de Deslocamento</label>
                            <div class="flex space-x-2" id="isochrone-mode">
                                <button data-mode="driving-car" class="flex-1 p-2 rounded-md border bg-blue-100 border-blue-500 text-blue-700">Carro</button>
                                <button data-mode="cycling-road" class="flex-1 p-2 rounded-md border">Bicicleta</button>
                                <button data-mode="foot-walking" class="flex-1 p-2 rounded-md border">Caminhada</button>
                            </div>
                            <label for="isochrone-value" class="block text-sm font-medium text-gray-700 mt-4">Tempo (minutos)</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="range" id="isochrone-range" min="5" max="60" value="10" class="w-full">
                                <input type="number" id="isochrone-value" value="10" class="w-20 p-1 border rounded-md text-center">
                            </div>
                        </div>
                        <div id="radius-options" class="hidden">
                             <label for="radius-value" class="block text-sm font-medium text-gray-700 mt-4">Distância (metros)</label>
                            <div class="flex items-center space-x-2 mt-1">
                                <input type="range" id="radius-range" min="500" max="10000" value="1500" step="100" class="w-full">
                                <input type="number" id="radius-value" value="1500" class="w-20 p-1 border rounded-md text-center">
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 p-2 bg-gray-50 rounded">Nota: A Isócrona requer uma chave de API gratuita do <a href="https://openrouteservice.org/dev/#/signup" target="_blank" class="text-blue-600 hover:underline">OpenRouteService</a>.</div>
                        <button id="apply-isochrone" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center justify-center">
                            <span id="apply-isochrone-text">Aplicar Deslocamento</span>
                            <div id="apply-isochrone-loader" class="loader hidden" style="border-top-color: white; width: 1.25rem; height: 1.25rem;"></div>
                        </button>
                    </div>
                </div>

                <div id="style-modal" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-2xl z-[1001] w-96">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Editar Estilo da Camada</h3>
                        <button id="close-style-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div id="style-color-option"><label for="style-color" class="block text-sm font-medium text-gray-700">Cor do Contorno</label><input type="color" id="style-color" class="mt-1 block w-full h-10"></div>
                        <div id="style-fill-color-option"><label for="style-fill-color" class="block text-sm font-medium text-gray-700">Cor do Preenchimento</label><input type="color" id="style-fill-color" class="mt-1 block w-full h-10"></div>
                        <div id="style-weight-option"><label for="style-weight-value" class="block text-sm font-medium text-gray-700">Espessura do Traço (px)</label><div class="flex items-center space-x-2 mt-1"><input type="range" id="style-weight-range" min="1" max="10" value="3" class="w-full"><input type="number" id="style-weight-value" value="3" class="w-20 p-1 border rounded-md text-center"></div></div>
                        <div id="style-opacity-option"><label for="style-opacity-value" class="block text-sm font-medium text-gray-700">Opacidade do Preenchimento (%)</label><div class="flex items-center space-x-2 mt-1"><input type="range" id="style-opacity-range" min="0" max="100" value="50" class="w-full"><input type="number" id="style-opacity-value" value="50" class="w-20 p-1 border rounded-md text-center"></div></div>
                        <button id="apply-style" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Aplicar Estilo</button>
                    </div>
                </div>

                <div id="point-style-modal" class="hidden absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-white p-6 rounded-lg shadow-2xl z-[1001] w-80">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-gray-800">Editar Ponto</h3>
                        <button id="close-point-style-modal" class="text-gray-500 hover:text-gray-800">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="point-name-input" class="block text-sm font-medium text-gray-700">Nome do Ponto</label>
                            <input type="text" id="point-name-input" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Cor do Ícone</label>
                            <div id="point-color-swatches" class="mt-2 flex flex-wrap gap-2">
                                </div>
                        </div>
                        <button id="apply-point-style" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">Salvar Alterações</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- 1. INICIALIZAÇÃO DO MAPA E VARIÁVEIS GLOBAIS ---
        
        const baseLayers = {
            'Claro': L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
            }),
            'Escuro': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }),
            'Satélite': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
            }),
            'Ruas': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            })
        };

        const map = L.map('map', { drawControl: false }).setView([-21.755, -41.31], 14);
        let currentBaseLayer = baseLayers['Claro'];
        currentBaseLayer.addTo(map);

        let legend = null;
        const activeLayers = {};
        const drawnItems = new L.FeatureGroup().addTo(map);
        let activeTool = null;
        let setoresCensitariosGeoJSON = null;
        let lastClickedLayer = null;
        let isochroneOrigin = null;
        let drawnLayerCounter = 0;
        let activeChoropleth = null;
        let currentlyEditingLayerId = null;
        let currentlyEditingPointLayerId = null;

        // --- 2. ENDPOINTS DA API (REAIS) ---
        const API_ENDPOINTS = {
            rfb_supermercados: 'https://gist.githubusercontent.com/google-gemini/95d8a264c243feb399083b135113a216/raw/supermercados.csv',
            rfb_farmacias: 'https://gist.githubusercontent.com/google-gemini/95d8a264c243feb399083b135113a216/raw/farmacias.csv',
            rfb_restaurantes: 'https://gist.githubusercontent.com/google-gemini/95d8a264c243feb399083b135113a216/raw/restaurantes.csv'
        };

        // --- 3. LÓGICA DA INTERFACE (ACORDEÃO E PAINÉIS) ---
        const accordionData=[{id:"accordion-drawn",title:"Minhas Camadas",content:[{type:"placeholder",text:"Use as ferramentas do mapa para adicionar camadas."}]},{id:"accordion-ibge",title:"Análise Sociodemográfica (IBGE)",content:[{type:"radio",name:"choropleth",value:"population",label:"População Residente",checked:!0},{type:"radio",name:"choropleth",value:"income",label:"Renda Média Domiciliar"}]},{id:"accordion-rfb",title:"Dados da Receita Federal (CNAE)",content:[{type:"checkbox",id:"rfb_supermercados",label:"Supermercados"},{type:"checkbox",id:"rfb_farmacias",label:"Farmácias"},{type:"checkbox",id:"rfb_restaurantes",label:"Restaurantes"}]},{id:"accordion-osm",title:"Dados Colaborativos (OpenStreetMap)",content:[{type:"checkbox",id:"osm_postos",label:"Postos de Combustível"}]}];const accordionContainer=document.getElementById("accordion-container");accordionData.forEach((e,t)=>{const o=document.createElement("div");o.id=e.id,o.className="accordion-item border-b border-gray-200",1===t&&o.classList.add("open");let n=e.content.map(l=>{const a=l.id||l.value,s=`<span class="text-gray-700">${l.label}</span><div id="loader_${a}" class="hidden"></div>`;return"placeholder"===l.type?`<p id="drawn-layers-placeholder" class="text-xs text-gray-500 p-2">${l.text}</p><div id="drawn-layers-list"></div>`:"radio"===l.type?`<label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="${l.name}" value="${l.value}" class="form-radio text-blue-600 choropleth-radio" ${l.checked?"checked":""}> ${s}</label>`:"checkbox"===l.type?`<label class="flex items-center space-x-2 cursor-pointer"><input type="checkbox" id="${l.id}" class="form-checkbox text-teal-500 rounded layer-checkbox"> ${s}</label>`:""}).join("");o.innerHTML=`\n                 <div class="accordion-header"><h3 class="font-semibold text-gray-600">${e.title}</h3><svg class="arrow w-5 h-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg></div>\n                 <div class="accordion-content"><div class="p-2 space-y-2">${n}</div></div>`,accordionContainer.appendChild(o)}),document.querySelectorAll(".accordion-header").forEach(e=>{e.addEventListener("click",()=>e.parentElement.classList.toggle("open"))});const infoPanel=document.getElementById("info-panel"),infoContent=document.getElementById("info-content");document.getElementById("close-info-panel").addEventListener("click",()=>infoPanel.classList.remove("open"));

        // --- 4. LÓGICA DE DADOS (CONEXÃO COM APIS REAIS) ---
        function toggleLoader(e,t){const o=document.getElementById(`loader_${e}`);o&&(o.className=t?"loader":"hidden")}async function getSetoresGeometria(){if(setoresCensitariosGeoJSON)return setoresCensitariosGeoJSON;toggleLoader("population",!0);try{const e=await fetch("https://raw.githubusercontent.com/tbrugz/geodata-br/master/geojson/geojs-33-mun.json");if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json(),o=t.features.filter(r=>r.properties.codarea.startsWith("3301009"));return o.forEach(r=>{r.properties.total_empresas=Math.floor(50*Math.random())+5,r.properties.top_cnae=["Varejo","Serviços","Saúde","Educação"][Math.floor(4*Math.random())]}),setoresCensitariosGeoJSON={...t,features:o},setoresCensitariosGeoJSON}catch(e){return console.error("Erro ao buscar geometria dos setores:",e),alert("Não foi possível carregar a malha de setores. Verifique a conexão e a fonte dos dados."),null}finally{toggleLoader("population",!1)}}async function fetchIBGEData(e,t){const o=`https://servicodados.ibge.gov.br/api/v3/agregados/${t}/periodos/2022/variaveis/${e}?localidades=N7[3301009]`;try{const n=await fetch(o);if(!n.ok)throw new Error(`HTTP error! status: ${n.status}`);const l=await n.json(),a=l[0].resultados[0].series,s={};return a.forEach(r=>{s[r.localidade.id]=parseFloat(r.serie["2022"])||0}),s}catch(n){return console.error(`Erro ao buscar dados do IBGE (Agregado: ${t}):`,n),{}}}async function fetchOverpassData(e){const t=map.getBounds(),o=`${t.getSouth()},${t.getWest()},${t.getNorth()},${t.getEast()}`,n=`[out:json][timeout:25];(${e});out center;`,l=`https://overpass-api.de/api/interpreter?data=${encodeURIComponent(n.replace(/{{bbox}}/g,o))}`;try{const a=await fetch(l);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);return(await a.json()).elements}catch(a){return console.error("Erro ao buscar dados do Overpass:",a),[]}}function parseCSV(e){const t=e.trim().split("\n"),o=t[0].split(",");return t.slice(1).map(n=>{const l=n.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g).map(s=>s.replace(/"/g,""));return o.reduce((s,a,i)=>(s[a.trim()]=l[i].trim(),s),{})})}
        
        // --- 5. LÓGICA DO MAPA (RENDERIZAÇÃO DE CAMADAS) ---
        function showInfoPanel(e){infoContent.innerHTML=`\n                 <div class="font-bold text-lg text-blue-700">${e.codarea}</div>\n                 <div class="mt-4">\n                     <h4 class="font-semibold text-gray-700 border-b pb-1 mb-2">Dados Sociodemográficos (IBGE)</h4>\n                     <p><strong>População Residente:</strong> ${e.pop?.toLocaleString("pt-BR")||"N/D"}</p>\n                     <p><strong>Renda Média Domiciliar:</strong> R$ ${e.renda?.toLocaleString("pt-BR",{minimumFractionDigits:2})||"N/D"}</p>\n                 </div>\n                 <div class="mt-4">\n                     <h4 class="font-semibold text-gray-700 border-b pb-1 mb-2">Dados Econômicos (RFB - Simulado)</h4>\n                     <p><strong>Total de Empresas:</strong> ${e.total_empresas}</p>\n                     <p><strong>Principal Atividade:</strong> ${e.top_cnae}</p>\n                 </div>\n             `,infoPanel.classList.add("open")}async function updateChoropleth(e){activeLayers.choropleth&&map.removeLayer(activeLayers.choropleth),legend&&map.removeControl(legend);if(!e||"clear"===e)return void(activeChoropleth=null);activeChoropleth=e,toggleLoader(e,!0);const t=await getSetoresGeometria();if(!t)return void toggleLoader(e,!1);let o={},n={};try{switch(e){case"population":o={dataKey:"pop",title:"População",breaks:[200,400,600,1e3,2e3]},n=await fetchIBGEData(93,9514);break;case"income":o={dataKey:"renda",title:"Renda Média (R$)",breaks:[800,1200,1800,2500,4e3]},n=await fetchIBGEData(996,9693)}}catch(l){return alert(`Falha ao carregar dados do IBGE para "${e}". Tente novamente.`),void toggleLoader(e,!1)}t.features.forEach(r=>{r.properties[o.dataKey]=n[r.properties.codarea]||0});const a=L.geoJson(t,{style:r=>({fillColor:getColor(r.properties[o.dataKey],o.breaks),weight:1,opacity:1,color:"white",fillOpacity:.7}),onEachFeature:(r,s)=>{s.on("click",d=>{lastClickedLayer&&activeLayers.choropleth.resetStyle(lastClickedLayer),d.target.setStyle({weight:3,color:"#0000FF"}),lastClickedLayer=d.target,showInfoPanel(r.properties)})}});activeLayers.choropleth=a.addTo(map),createLegend(o.breaks,o.title),toggleLoader(e,!1)}async function togglePointLayer(e,t,o,n){if(activeLayers[e])return map.removeLayer(activeLayers[e]),void delete activeLayers[e];toggleLoader(e,!0);let l;try{if("osm"===n)l=await fetchOverpassData(t);else if("rfb"===n){const a=await fetch(t);if(!a.ok)throw new Error(`HTTP error! status: ${a.status}`);const s=await a.text();l=parseCSV(s)}}catch(a){return alert(`Não foi possível carregar os dados para ${e}.`),toggleLoader(e,!1),void(document.getElementById(e).checked=!1)}toggleLoader(e,!1);const i=L.layerGroup();l.forEach(r=>{const s=r.lat||r.center?.lat||r.latitude,d=r.lon||r.center?.lon||r.longitude,c=r.tags?.name||r.nome||"Estabelecimento";s&&d&&L.marker([s,d],{icon:o}).bindPopup(`<b>${c}</b>`).addTo(i)}),activeLayers[e]=i.addTo(map)}function getColor(e,t){return e>t[4]?"#800026":e>t[3]?"#BD0026":e>t[2]?"#E31A1C":e>t[1]?"#FC4E2A":e>t[0]?"#FD8D3C":"#FFFFFF"}function createLegend(e,t){legend&&map.removeControl(legend),legend=L.control({position:"bottomright"}),legend.onAdd=function(o){const n=L.DomUtil.create("div","info legend"),l=[e[0],e[1],e[2],e[3],e[4]];n.innerHTML+=`<strong>${t}</strong><br>`;for(let a=0;a<l.length;a++){const s=l[a],i=l[a+1];n.innerHTML+='<i style="background:'+getColor(s+1,e)+'"></i> '+s.toLocaleString("pt-BR")+(i?" &ndash; "+i.toLocaleString("pt-BR")+"<br>":"+")}return n},legend.addTo(map)}

        // --- 6. EVENT LISTENERS E INICIALIZAÇÃO ---
        document.querySelectorAll('.choropleth-radio').forEach(radio=>{radio.addEventListener('click',e=>{if(e.target.value===activeChoropleth){e.target.checked=!1;updateChoropleth('clear')}else{updateChoropleth(e.target.value)}})});const layerMapping={rfb_supermercados:{source:API_ENDPOINTS.rfb_supermercados,type:'rfb',icon:L.icon({iconUrl:'https://img.icons8.com/plasticine/100/000000/shopping-cart.png',iconSize:[32,32]})},rfb_farmacias:{source:API_ENDPOINTS.rfb_farmacias,type:'rfb',icon:L.icon({iconUrl:'https://img.icons8.com/plasticine/100/000000/pharmacy.png',iconSize:[32,32]})},rfb_restaurantes:{source:API_ENDPOINTS.rfb_restaurantes,type:'rfb',icon:L.icon({iconUrl:'https://img.icons8.com/plasticine/100/000000/restaurant.png',iconSize:[32,32]})},osm_postos:{source:'node["amenity"="fuel"]({{bbox}});',type:'osm',icon:L.icon({iconUrl:'https://img.icons8.com/plasticine/100/000000/gas-station.png',iconSize:[32,32]})}};document.querySelectorAll('.layer-checkbox').forEach(checkbox=>{checkbox.addEventListener('change',e=>{const mapping=layerMapping[e.target.id];if(mapping){togglePointLayer(e.target.id,mapping.source,mapping.icon,mapping.type)}})});
        
        // --- 7. LÓGICA DAS FERRAMENTAS ---
        const toolButtons = document.querySelectorAll('.toolbar-btn');
        function deactivateAllTools(){if(activeTool){activeTool.disable();activeTool=null}toolButtons.forEach(btn=>btn.classList.remove('active'));document.getElementById('map').style.cursor='default'}
        function activateTool(toolName,buttonEl){deactivateAllTools();buttonEl.classList.add('active');document.getElementById('map').style.cursor='crosshair';switch(toolName){case'point':activeTool=new L.Draw.Marker(map,{icon:createCustomMarkerIcon()});break;case'polygon':activeTool=new L.Draw.Polygon(map,{shapeOptions:{color:'#3b82f6'}});break;case'ruler':activeTool=new L.Draw.Polyline(map,{shapeOptions:{color:'#f59e0b'}});break;case'isochrone':document.getElementById('map').style.cursor='pointer';map.once('click',e=>{isochroneOrigin=e.latlng;document.getElementById('isochrone-modal').classList.remove('hidden');deactivateAllTools()});return}activeTool.enable()}
        
        function addLayerToManager(layer, type, details) {
            drawnLayerCounter++;
            const layerId = `drawn_${drawnLayerCounter}`;
            layer.customId = layerId;
            let layerName;

            if (type === 'marker') {
                layerName = `Ponto ${drawnLayerCounter}`;
                layer.options.customName = layerName;
                layer.options.customColor = '#3b82f6';
            } else if (details?.type === 'isochrone' || details?.type === 'radius') {
                layerName = details.name;
                layer.options.customName = layerName;
            } else {
                 const typeNames = {'polygon': 'Desenho Livre', 'polyline': 'Régua'};
                 layerName = `${typeNames[type] || 'Camada'} ${drawnLayerCounter}`;
                 layer.options.customName = layerName;
            }

            activeLayers[layerId] = layer;
            const list = document.getElementById('drawn-layers-list');
            document.getElementById('drawn-layers-placeholder').classList.add('hidden');
            
            const item = document.createElement('div');
            item.className = 'layer-manager-item';
            item.id = `manager-item-${layerId}`;
            item.innerHTML = `
                <span class="text-sm layer-name-display">${layerName}</span>
                <div class="actions flex items-center space-x-1">
                    ${type === 'marker' ? `<button data-action="edit-point" data-layer-id="${layerId}" title="Editar Ponto">
                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16"><path d="M15.502 1.94a.5.5 0 0 1 0 .706L14.459 3.69l-2-2L13.502.646a.5.5 0 0 1 .707 0l1.293 1.293zm-1.75 2.456-2-2L4.939 9.25l-2.79 2.79a.5.5 0 0 0-.14.283L1.171 14.5a.5.5 0 0 0 .586.586l2.176-1.026a.5.5 0 0 0 .283-.14L13.752 4.4z"/></svg>
                    </button>` : ''}
                    <button data-action="toggle" data-layer-id="${layerId}" title="Mostrar/Ocular"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8zM1.173 8a13.133 13.133 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5c2.12 0 3.879 1.168 5.168 2.457A13.133 13.133 0 0 1 14.828 8c-.058.087-.122.183-.195.288-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5c-2.12 0-3.879-1.168-5.168-2.457A13.134 13.134 0 0 1 1.172 8z"/><path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5zM4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0z"/></svg></button>
                    <button data-action="delete" data-layer-id="${layerId}" title="Excluir"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></button>
                </div>`;
            list.appendChild(item);
        }

        document.getElementById('drawn-layers-list').addEventListener('click', e => {
            const button = e.target.closest('button');
            if (!button) return;
            const action = button.dataset.action;
            const layerId = button.dataset.layerId;
            const layer = activeLayers[layerId];
            if (!layer) return;

            if (action === 'toggle') {
                if(map.hasLayer(layer)){ map.removeLayer(layer); button.style.color = '#ef4444'; } 
                else { map.addLayer(layer); button.style.color = '#9ca3af'; }
            } else if (action === 'delete') {
                if(map.hasLayer(layer)){ map.removeLayer(layer); }
                delete activeLayers[layerId];
                document.getElementById(`manager-item-${layerId}`).remove();
                if(document.getElementById('drawn-layers-list').children.length === 0){
                    document.getElementById('drawn-layers-placeholder').classList.remove('hidden');
                }
            } else if (action === 'edit-point') {
                currentlyEditingPointLayerId = layerId;
                const pointStyleModal = document.getElementById('point-style-modal');
                document.getElementById('point-name-input').value = layer.options.customName;
                document.querySelectorAll('#point-color-swatches button').forEach(btn => {
                    btn.classList.toggle('ring-2', btn.dataset.color === layer.options.customColor);
                    btn.classList.toggle('ring-offset-1', btn.dataset.color === layer.options.customColor);
                    btn.classList.toggle('ring-gray-800', btn.dataset.color === layer.options.customColor);
                });
                pointStyleModal.classList.remove('hidden');
            }
        });

        toolButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const toolId = e.currentTarget.id;
                const toolName = toolId.replace('tool-', '');
                if (e.currentTarget.classList.contains('active')) {
                    deactivateAllTools();
                } else {
                    if (toolName === 'export') { /* lógica de exportação */ } 
                    else { activateTool(toolName, e.currentTarget); }
                }
            });
        });

        map.on(L.Draw.Event.CREATED, function (event) {
            const layer = event.layer;
            const type = event.layerType;
            addLayerToManager(layer, type);
            layer.addTo(map);
            deactivateAllTools();
        });
        
        function createBasemapSwitcher() {
            const switcherContainer = document.getElementById('basemap-switcher');
            const basemapThumbnails = {
                'Claro': 'https://carto.com/help/images/building-maps/basemaps/positron.png',
                'Escuro': 'https://carto.com/help/images/building-maps/basemaps/dark-matter.png',
                'Satélite': 'https://www.esri.com/arcgis-blog/wp-content/uploads/2021/11/world-imagery-wayback-2021-1024x725.png',
                'Ruas': 'https://www.openstreetmap.org/assets/about/osm-a74d20035a57662eaa360a09971914c45388d75723947497f58b0292b0365a7e.png'
            };

            Object.keys(baseLayers).forEach(name => {
                const button = document.createElement('button');
                button.className = 'p-1 rounded-md border-2 border-transparent hover:border-blue-500 transition-all group';
                button.title = name;
                if (name === 'Claro') button.classList.add('border-blue-500');
                
                button.innerHTML = `
                    <img src="${basemapThumbnails[name]}" alt="${name}" class="w-16 h-12 object-cover rounded-sm">
                    <span class="text-xs block text-center font-medium text-gray-600 group-hover:text-blue-600">${name}</span>`;
                
                button.addEventListener('click', () => {
                    if (currentBaseLayer !== baseLayers[name]) {
                        map.removeLayer(currentBaseLayer);
                        currentBaseLayer = baseLayers[name];
                        map.addLayer(currentBaseLayer);
                        currentBaseLayer.bringToBack();
                        switcherContainer.querySelectorAll('button').forEach(btn => btn.classList.remove('border-blue-500'));
                        button.classList.add('border-blue-500');
                    }
                });
                switcherContainer.appendChild(button);
            });
        }
        
        function createCustomMarkerIcon(color = '#3b82f6') {
            const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="32" height="32" fill="${color}" style="drop-shadow: 2px 2px 2px rgba(0,0,0,0.3);"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>`;
            return L.divIcon({
                html: svgIcon,
                className: '',
                iconSize: [32, 32],
                iconAnchor: [16, 32],
                popupAnchor: [0, -32]
            });
        }
        
        const pointStyleModal = document.getElementById('point-style-modal');
        const pointNameInput = document.getElementById('point-name-input');
        const pointColorSwatches = document.getElementById('point-color-swatches');
        const pointColors = ['#e53935', '#d81b60', '#8e24aa', '#5e35b1', '#3949ab', '#1e88e5', '#039be5', '#00acc1', '#00897b', '#43a047', '#fdd835', '#fb8c00', '#f4511e', '#6d4c41', '#757575', '#546e7a'];

        pointColors.forEach(color => {
            const swatch = document.createElement('button');
            swatch.className = 'w-8 h-8 rounded-full border-2 border-white ring-1 ring-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500';
            swatch.style.backgroundColor = color;
            swatch.dataset.color = color;
            swatch.addEventListener('click', () => {
                pointColorSwatches.querySelectorAll('button').forEach(btn => btn.classList.remove('ring-2', 'ring-offset-1', 'ring-gray-800'));
                swatch.classList.add('ring-2', 'ring-offset-1', 'ring-gray-800');
            });
            pointColorSwatches.appendChild(swatch);
        });

        document.getElementById('close-point-style-modal').addEventListener('click', () => {
            pointStyleModal.classList.add('hidden');
            currentlyEditingPointLayerId = null;
        });

        document.getElementById('apply-point-style').addEventListener('click', () => {
            if (!currentlyEditingPointLayerId) return;
            const layer = activeLayers[currentlyEditingPointLayerId];
            if (!layer) return;

            const newName = pointNameInput.value.trim();
            const selectedSwatch = pointColorSwatches.querySelector('.ring-gray-800');
            const newColor = selectedSwatch ? selectedSwatch.dataset.color : layer.options.customColor;
            
            layer.options.customName = newName || `Ponto ${currentlyEditingPointLayerId.split('_')[1]}`;
            layer.options.customColor = newColor;
            layer.setIcon(createCustomMarkerIcon(newColor));

            const managerItem = document.getElementById(`manager-item-${currentlyEditingPointLayerId}`);
            if (managerItem) managerItem.querySelector('.layer-name-display').textContent = layer.options.customName;
            
            pointStyleModal.classList.add('hidden');
            currentlyEditingPointLayerId = null;
        });

        const isochroneModal = document.getElementById('isochrone-modal');
        const calcTypeBtns = document.querySelectorAll('#isochrone-calc-type button');
        const isochroneOptions = document.getElementById('isochrone-options');
        const radiusOptions = document.getElementById('radius-options');
        const isochroneModeBtns = document.querySelectorAll('#isochrone-mode button');
        let currentIsochroneMode = 'driving-car';
        let currentCalcType = 'isochrone';

        calcTypeBtns.forEach(btn=>{btn.addEventListener('click',()=>{calcTypeBtns.forEach(b=>b.classList.remove('bg-blue-100','border-blue-500','text-blue-700'));btn.classList.add('bg-blue-100','border-blue-500','text-blue-700');currentCalcType=btn.dataset.type;if(currentCalcType==='isochrone'){isochroneOptions.classList.remove('hidden');radiusOptions.classList.add('hidden')}else{isochroneOptions.classList.add('hidden');radiusOptions.classList.remove('hidden')}})});
        isochroneModeBtns.forEach(btn=>{btn.addEventListener('click',()=>{isochroneModeBtns.forEach(b=>b.classList.remove('bg-blue-100','border-blue-500','text-blue-700'));btn.classList.add('bg-blue-100','border-blue-500','text-blue-700');currentIsochroneMode=btn.dataset.mode})});
        document.getElementById('isochrone-range').addEventListener('input',e=>document.getElementById('isochrone-value').value=e.target.value);document.getElementById('isochrone-value').addEventListener('input',e=>document.getElementById('isochrone-range').value=e.target.value);document.getElementById('radius-range').addEventListener('input',e=>document.getElementById('radius-value').value=e.target.value);document.getElementById('radius-value').addEventListener('input',e=>document.getElementById('radius-range').value=e.target.value);
        document.getElementById('close-isochrone-modal').addEventListener('click',()=>isochroneModal.classList.add('hidden'));
        
        document.getElementById('apply-isochrone').addEventListener('click',async()=>{
            if(!isochroneOrigin)return;
            const applyBtnText=document.getElementById('apply-isochrone-text');
            const applyBtnLoader=document.getElementById('apply-isochrone-loader');
            applyBtnText.classList.add('hidden');
            applyBtnLoader.classList.remove('hidden');
            if(currentCalcType==='radius'){
                const distanceMeters=parseInt(document.getElementById('radius-value').value);
                const circle=L.circle(isochroneOrigin,{radius:distanceMeters,color:'#1d4ed8',fillColor:'#3b82f6',fillOpacity:0.3});
                addLayerToManager(circle, 'circle', { type: 'radius', name: `Raio (${distanceMeters}m)` });
                circle.addTo(map);
                isochroneModal.classList.add('hidden');
                applyBtnText.classList.remove('hidden');
                applyBtnLoader.classList.add('hidden');
                return;
            }
            const timeInMinutes=parseInt(document.getElementById('isochrone-value').value);
            const timeInSeconds=timeInMinutes*60;
            
            // Sua chave de API está inserida aqui.
            const apiKey='eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImNkODI1ZGVhMDcxZjRhYTI5YTc1ZmViMzA0MTYwOGYyIiwiaCI6Im11cm11cjYyIn0=';
            
            if(!apiKey||apiKey==='eyJvcmciOiI1YjNjZTM1OTc4NTExMTAwMDFjZjYyNDgiLCJpZCI6ImNkODI1ZGVhMDcxZjRhYTI5YTc1ZmViMzA0MTYwOGYyIiwiaCI6Im11cm11cjYyIn0='){
                alert('Por favor, insira uma chave de API do OpenRouteService no código para usar a funcionalidade de isócrona.');
                applyBtnText.classList.remove('hidden');
                applyBtnLoader.classList.add('hidden');
                return
            }

            const url=`https://api.openrouteservice.org/v2/isochrones/${currentIsochroneMode}`;
            try{
                const response=await fetch(url,{method:'POST',headers:{'Authorization':apiKey,'Content-Type':'application/json'},body:JSON.stringify({locations:[[isochroneOrigin.lng,isochroneOrigin.lat]],range:[timeInSeconds],range_type:'time'})});
                if(!response.ok){
                    const errorData=await response.json();
                    throw new Error(errorData.error?.message||`HTTP error! status: ${response.status}`)
                }
                const data=await response.json();
                const isochronePolygon=L.geoJson(data,{style:{color:'#1d4ed8',fillColor:'#3b82f6',fillOpacity:0.3}});
                const modeText = currentIsochroneMode.replace('driving-', '').replace('cycling-', '').replace('foot-', '');
                addLayerToManager(isochronePolygon, 'isochrone', { type: 'isochrone', name: `Desloc. (${modeText}, ${timeInMinutes} min)` });
                isochronePolygon.addTo(map);
                isochroneModal.classList.add('hidden');
            } catch(error) {
                alert(`Não foi possível calcular a área de deslocamento. Verifique sua chave de API. Detalhes: ${error.message}`);
            } finally {
                applyBtnText.classList.remove('hidden');
                applyBtnLoader.classList.add('hidden');
            }
        });

        // --- INICIALIZAÇÃO FINAL ---
        updateChoropleth('population');
        createBasemapSwitcher();
    </script>
</body>
</html>
